(function(){var t,e;t=function(){function t(t){this.layout=t}return t.prototype.remove_submodule=function(t){return $(".module-sub[data-uuid="+t+"]").remove(),this.each_module(function(e){return function(n){return $.each(n.submodules,function(o,u){return u.uuid===t?(n.submodules.splice(o,1),e.change_callback()):void 0})}}(this))},t.prototype.append_submodule=function(t,e){return this.each_module(function(n){return function(o){return o.uuid===t?(o.submodules.push(e),n.change_callback()):void 0}}(this))},t.prototype.append_row=function(t){return this.layout.push(t),this.change_callback()},t.prototype.remove_row=function(t){return $(".row[data-uuid="+t+"]").remove(),$.each(this.layout,function(e){return function(n,o){return o.uuid===t?(e.layout.splice(n,1),e.change_callback()):void 0}}(this))},t.prototype.children_count=function(t){var e;return e=this.get_layout_element_by_path(t),e.modules?e.modules.length:e.submodules?e.submodules.length:0},t.prototype.prev_path=function(t){switch(t.length){case 1:return[t[0]-1];case 2:return 0===t[1]?[t[0]-1,this.children_count([t[0]-1])-1]:[t[0],t[1]-1]}},t.prototype.next_path=function(t){var e;switch(t.length){case 1:return[t[0]+1];case 2:return e=this.children_count([t[0]]),t[1]===e-1?[t[0]+1,0]:[t[0],t[1]+1]}},t.prototype.of_compatible_size=function(t,e){var n,o;return n=this.get_layout_element_by_path(t),o=this.get_layout_element_by_path(e),n.cols&&t[0]!==e[0]?n.cols===o.cols:!0},t.prototype.move_row_upward=function(t){var e,n,o;return o=this.get_layout_element(t),e=o[0],n=o[1],this.swap_paths(n,this.prev_path(n)),this.change_callback()},t.prototype.move_row_downward=function(t){var e,n,o;return o=this.get_layout_element(t),e=o[0],n=o[1],this.swap_paths(n,this.next_path(n)),this.change_callback()},t.prototype.move_module_leftward=function(t){var e,n,o;return o=this.get_layout_element(t),e=o[0],n=o[1],this.swap_paths(n,this.prev_path(n)),this.change_callback()},t.prototype.move_module_rightward=function(t){var e,n,o;return o=this.get_layout_element(t),e=o[0],n=o[1],this.swap_paths(n,this.next_path(n)),this.change_callback()},t.prototype.get_element_by_uuid=function(t){return $("[data-uuid="+t+"]")},t.prototype.swap_elements=function(t,e){var n,o,u,a,r,i;return r=this.get_layout_element(t),n=r[0],u=r[1],i=this.get_layout_element(e),o=i[0],a=i[1],this.of_compatible_size(u,a)?(this.swap_layout_elements(t,e),this.swap_dom_elements(t,e)):void alert("You can only swap elements of compatible sizes. ")},t.prototype.swap_paths=function(t,e){var n,o;return n=this.get_layout_element_by_path(t),o=this.get_layout_element_by_path(e),n&&o?this.swap_elements(n.uuid,o.uuid):void 0},t.prototype.get_layout_element=function(t){var e,n;return e=null,n=null,this.each_row(function(o,u){var a;return o.uuid===t?(a=[o,u],e=a[0],n=a[1],a):void 0}),e?[e,n]:(this.each_module(function(o,u){var a;return o.uuid===t?(a=[o,u],e=a[0],n=a[1],a):void 0}),e?[e,n]:(this.each_submodule(function(o,u){var a;return o.uuid===t?(a=[o,u],e=a[0],n=a[1],a):void 0}),e?[e,n]:[null,null]))},t.prototype.set_layout_element=function(t,e){switch(t.length){case 1:return this.layout[t[0]]=e;case 2:return this.layout[t[0]].modules[t[1]]=e;case 3:return this.layout[t[0]].modules[t[1]].submodules[t[2]]=e}},t.prototype.get_layout_element_by_path=function(t){switch(t.length){case 1:return this.layout[t[0]];case 2:return this.layout[t[0]].modules[t[1]];case 3:return this.layout[t[0]].modules[t[1]].submodules[t[2]]}},t.prototype.swap_layout_elements=function(t,e){var n,o,u,a,r,i;return r=this.get_layout_element(t),n=r[0],u=r[1],i=this.get_layout_element(e),o=i[0],a=i[1],u&&a?(this.set_layout_element(u,o),this.set_layout_element(a,n)):void 0},t.prototype.swap_dom_elements=function(t,e){var n,o,u;return n=this.get_element_by_uuid(t),o=this.get_element_by_uuid(e),u=n[0].outerHTML,n.replaceWith(o[0].outerHTML),o.replaceWith(u)},t.prototype.edit_submodule_field=function(t,e,n){return this.each_submodule(function(o){return function(u){return u.uuid===t?(u[e]=n,o.change_callback()):void 0}}(this))},t.prototype.each_row=function(t){return $.each(this.layout,function(e,n){return t(n,[e])})},t.prototype.each_module=function(t){return this.each_row(function(e,n){return $.each(e.modules,function(e,o){return t(o,n.concat([e]))})})},t.prototype.each_submodule=function(t){return this.each_module(function(e,n){return $.each(e.submodules,function(e,o){return t(o,n.concat([e]))})})},t.prototype.on_change=function(t){return this.change_callback=t},t}(),jQuery.fn.toggleAttr=function(t){return this.each(function(){var e;e=$(this),e.attr(t)?e.removeAttr(t):e.attr(t,"true")})},e=function(){return $(".homepages_show").length>0?(window.homepage=new t(gon.layout),window.homepage.on_change(function(){return window.homepage_changed=!0}),$("#save_layout").click(function(){return $(window).unbind("beforeunload"),$("#save_layout_form input[name=layout]").val(JSON.stringify(window.homepage.layout)),$("#save_layout_form").submit(),!1}),$("#mark_publish_ready").click(function(){return confirm("Are you sure that you want to mark this layout as publish ready? ")&&($(window).unbind("beforeunload"),$("#mark_publish_ready_form input[name=layout]").val(JSON.stringify(window.homepage.layout)),$("#mark_publish_ready_form").submit()),!1}),$(".flash").length>0&&$(".master-editing-toolbar").css("opacity","1"),$(document).on("dblclick","*[data-editable]",function(){return $(this).toggleAttr("contenteditable")}),$(document).on("blur keyup paste input","*[data-editable]",function(){var t,e,n;return e=$(this).parents(".module-sub").data("uuid"),t=$(this).data("editable"),n=$(this).text(),$(this).html(n),window.homepage.edit_submodule_field(e,t,n)}),$(window).on("unload",function(){return console.log(window.homepage.layout)}),$(window).on("beforeunload",function(){return window.homepage_changed?"Layout has been changed yet not saved. Discard changes? ":void 0})):void 0},$(e)}).call(this);