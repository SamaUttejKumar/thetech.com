!function(t){"use strict";t.support.pushState=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);var e={init:function(e,n){n.options=t.extend({scrollContainer:window,scrollPadding:100,scrollEventDelay:300},e),this.options=n.options,this.container=n.container,n.scrollModule=this,this._toplock=!0,this._bottomlock=!0,this.scrollContainer=t(this.options.scrollContainer),this.updateEntities(),this.sortMarkers(),this.currentPage=null,this.container.on("jes:afterPageLoad",t.proxy(function(t,e,n){if(this.updateEntities(),this.sortMarkers(),this.checkMarker(),"top"==n){var i=this.markers[1].top,r=this.scrollContainer.scrollTop();this.scrollContainer.scrollTop(r+i)}},this)),this.bind()},updateEntities:function(){this.entities=t(this.options.entity,this.container)},sortMarkers:function(){var e=[];t(".jes-marker",this.container).each(function(){e.push({top:t(this).position().top,url:t(this).data("jesUrl")})}),this.markers=e},checkMarker:function(){for(var e=this.markers[0],n=this.scrollContainer.scrollTop(),i=1;i<this.markers.length&&n>this.markers[i].top;i++)e=this.markers[i];e.url!=this.currentPage&&(this.currentPage=e.url,t(this.container).trigger("jes:scrollToPage",e.url))},bind:function(){this.scrollContainer.on("scroll.jes",t.proxy(function(e){this._tId||(this.scrollHandler(e),this._tId=setTimeout(t.proxy(function(){this._tId=null},this),this.options.scrollEventDelay))},this))},unbind:function(){t(this.options.scrollContainer).off("scroll.jes")},scrollHandler:function(){var e=this.scrollContainer,n=this.entities,i=n.first(),r=n.last(),o=e.scrollTop(),a=e.height(),s=o+a,l=i.position().top,u=l+this.options.scrollPadding,c=r.outerHeight()+r.position().top,d=c-this.options.scrollPadding;o<u?this._toplock||(t(this.container).trigger("jes:topThreshold"),this._toplock=!0):this._toplock=!1,s>d?this._bottomlock||(t(this.container).trigger("jes:bottomThreshold"),this._bottomlock=!0):this._bottomlock=!1,this.checkMarker()}},n={init:function(e,n){n.options=t.extend({},e),this.options=n.options,this.container=n.container,this.setMarker(t(this.options.entity,this.container).first(),location.href),n.ajaxModule=this},loadPage:function(e,n,i){var r={top:{find:"first",inject:"insertBefore"},bottom:{find:"last",inject:"insertAfter"}},o=r[n];this.container.trigger("jes:beforePageLoad",[e,n]),t.get(e,null,t.proxy(function(r){var a=t("<div>").html(r),s=this.options.container,l=t(s,a).first();if(l.length){var u=l.find(this.options.entity);"bottom"==n&&u.each(function(){var e=t(this).attr("id");e&&t("#"+e,this.container).remove()});var c=t(this.options.entity,s)[o.find]();u[o.inject](c),this.setMarker(u.first(),e)}t.isFunction(i)&&i(a),this.container.trigger("jes:afterPageLoad",[e,n,a,u])},this),"html")},setMarker:function(t,e){t.addClass("jes-marker").data("jesUrl",e)}},i={init:function(e,n){n.options=t.extend({nextPage:".pagination a[rel=next]",previousPage:".pagination a[rel=previous]"},e),this.options=n.options,this.container=n.container,t.each([{selector:this.options.nextPage,event:"jes:bottomThreshold.navigation",placement:"bottom"},{selector:this.options.previousPage,event:"jes:topThreshold.navigation",placement:"top"}],t.proxy(function(e,i){if(i.element=t(i.selector),i.element.length){var r=i.element.prop("href"),o=!1,a=function(){!o&&r&&(o=!0,n.ajaxModule.loadPage(r,i.placement,t.proxy(function(e){var n=t(i.selector,t(e));n.length?(o=!1,r=n.prop("href"),i.element.attr("href",r)):(t(this).off(i.event),i.element.remove())},this)))};t(this.container).on(i.event,a),t(i.element).on("click",t.proxy(function(t){t.preventDefault(),a.apply(this.container)},this))}},this))}},r={init:function(e,n){t.support.pushState&&n.container.on("jes:scrollToPage",function(t,e){history.replaceState({},null,e)})}};t.endlessScroll=function(o){if(this.options=t.extend(!0,{container:"#container",entity:".entity",_modules:[n,e,i,r],modules:[]},o),this.container=t(this.options.container),!this.container.length)throw"Container for endless scroll isn't available on the page";return t.merge(this.options.modules,this.options._modules),this.options.modules.forEach(t.proxy(function(t){t.init(this.options,this)},this)),this}}(jQuery);