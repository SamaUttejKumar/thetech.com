!function(){function e(e){function a(){this.deflated||(e.widgets.focused==this.widget&&(this.focused=!0),e.widgets.destroy(this.widget),this.deflated=!0)}function i(){var t=e.editable(),n=e.document;if(this.deflated)this.widget=e.widgets.initOn(this.element,"image",this.widget.data),this.widget.inline&&!new CKEDITOR.dom.elementPath(this.widget.wrapper,t).block&&(t=n.createElement(e.activeEnterMode==CKEDITOR.ENTER_P?"p":"div"),t.replace(this.widget.wrapper),this.widget.wrapper.move(t)),this.focused&&(this.widget.focus(),delete this.focused),delete this.deflated;else{var a=this.widget,t=r,n=a.wrapper,i=a.data.align,a=a.data.hasCaption;if(t){for(var o=3;o--;)n.removeClass(t[o]);"center"==i?a&&n.addClass(t[1]):"none"!=i&&n.addClass(t[p[i]])}else"center"==i?(a?n.setStyle("text-align","center"):n.removeStyle("text-align"),n.removeStyle("float")):("none"==i?n.removeStyle("float"):n.setStyle("float",i),n.removeStyle("text-align"))}}var r=e.config.image2_alignClasses,s=e.config.image2_captionedClass;return{allowedContent:c(e),requiredContent:"img[src,alt]",features:u(e),styleableElements:"img figure",contentTransformations:[["img[width]: sizeToAttribute"]],editables:{caption:{selector:"figcaption",allowedContent:"br em strong sub sup u s; a[!href]"}},parts:{image:"img",caption:"figcaption"},dialog:"image2",template:'<img alt="" src="" />',data:function(){var t=this.features;if(this.data.hasCaption&&!e.filter.checkFeature(t.caption)&&(this.data.hasCaption=!1),"none"==this.data.align||e.filter.checkFeature(t.align)||(this.data.align="none"),this.shiftState({widget:this,element:this.element,oldData:this.oldData,newData:this.data,deflate:a,inflate:i}),this.data.link?this.parts.link||(this.parts.link=this.parts.image.getParent()):this.parts.link&&delete this.parts.link,this.parts.image.setAttributes({src:this.data.src,"data-cke-saved-src":this.data.src,alt:this.data.alt}),this.oldData&&!this.oldData.hasCaption&&this.data.hasCaption)for(var n in this.data.classes)this.parts.image.removeClass(n);if(e.filter.checkFeature(t.dimension)){t=this.data,t={width:t.width,height:t.height},n=this.parts.image;for(var o in t)t[o]?n.setAttribute(o,t[o]):n.removeAttribute(o)}this.oldData=CKEDITOR.tools.extend({},this.data)},init:function(){var t=CKEDITOR.plugins.image2,n=this.parts.image,a={hasCaption:!!this.parts.caption,src:n.getAttribute("src"),alt:n.getAttribute("alt")||"",width:n.getAttribute("width")||"",height:n.getAttribute("height")||"",lock:!this.ready||t.checkHasNaturalRatio(n)},i=n.getAscendant("a");i&&this.wrapper.contains(i)&&(this.parts.link=i),a.align||(n=a.hasCaption?this.element:n,r?(n.hasClass(r[0])?a.align="left":n.hasClass(r[2])&&(a.align="right"),a.align?n.removeClass(r[p[a.align]]):a.align="none"):(a.align=n.getStyle("float")||"none",n.removeStyle("float"))),e.plugins.link&&this.parts.link&&(a.link=t.getLinkAttributesParser()(e,this.parts.link),(n=a.link.advanced)&&n.advCSSClasses&&(n.advCSSClasses=CKEDITOR.tools.trim(n.advCSSClasses.replace(/cke_\S+/,"")))),this.wrapper[(a.hasCaption?"remove":"add")+"Class"]("cke_image_nocaption"),this.setData(a),e.filter.checkFeature(this.features.dimension)&&!0!==e.config.image2_disableResizer&&o(this),this.shiftState=t.stateShifter(this.editor),this.on("contextMenu",function(e){e.data.image=CKEDITOR.TRISTATE_OFF,(this.parts.link||this.wrapper.getAscendant("a"))&&(e.data.link=e.data.unlink=CKEDITOR.TRISTATE_OFF)}),this.on("dialog",function(e){e.data.widget=this},this)},addClass:function(e){d(this).addClass(e)},hasClass:function(e){return d(this).hasClass(e)},removeClass:function(e){d(this).removeClass(e)},getClasses:function(){var e=new RegExp("^("+[].concat(s,r).join("|")+")$");return function(){var t,n=this.repository.parseElementClasses(d(this).getAttribute("class"));for(t in n)e.test(t)&&delete n[t];return n}}(),upcast:t(e),downcast:n(e)}}function t(e){var t=a(e),n=e.config.image2_captionedClass;return function(e,a){var o,r={width:1,height:1},s=e.name;if(!e.attributes["data-cke-realelement"]&&(t(e)?("div"==s&&(o=e.getFirst("figure"))&&(e.replaceWith(o),e=o),a.align="center",o=e.getFirst("img")||e.getFirst("a").getFirst("img")):"figure"==s&&e.hasClass(n)?o=e.getFirst("img")||e.getFirst("a").getFirst("img"):i(e)&&(o="a"==e.name?e.children[0]:e),o)){for(var l in r)(r=o.attributes[l])&&r.match(m)&&delete o.attributes[l];return e}}}function n(e){var t=e.config.image2_alignClasses;return function(e){var n="a"==e.name?e.getFirst():e,a=n.attributes,i=this.data.align;if(!this.inline){var o=e.getFirst("span");o&&o.replaceWith(o.getFirst({img:1,a:1}))}return i&&"none"!=i&&(o=CKEDITOR.tools.parseCssText(a.style||""),"center"==i&&"figure"==e.name?e=e.wrapWith(new CKEDITOR.htmlParser.element("div",t?{"class":t[1]}:{style:"text-align:center"})):i in{left:1,right:1}&&(t?n.addClass(t[p[i]]):o["float"]=i),t||CKEDITOR.tools.isEmpty(o)||(a.style=CKEDITOR.tools.writeCssText(o))),e}}function a(e){var t=e.config.image2_captionedClass,n=e.config.image2_alignClasses,a={figure:1,a:1,img:1};return function(o){if(!(o.name in{div:1,p:1}))return!1;var r=o.children;if(1!==r.length)return!1;if(r=r[0],!(r.name in a))return!1;if("p"==o.name){if(!i(r))return!1}else if("figure"==r.name){if(!r.hasClass(t))return!1}else if(e.enterMode==CKEDITOR.ENTER_P||!i(r))return!1;return!(n?!o.hasClass(n[1]):"center"!=CKEDITOR.tools.parseCssText(o.attributes.style||"",!0)["text-align"])}}function i(e){return"img"==e.name||"a"==e.name&&(1==e.children.length&&e.getFirst("img"))}function o(e){var t=e.editor,n=t.editable(),a=t.document,i=e.resizer=a.createElement("span");if(i.addClass("cke_image_resizer"),i.setAttribute("title",t.lang.image2.resizer),i.append(new CKEDITOR.dom.text("\u200b",a)),e.inline)e.wrapper.append(i);else{var o=e.parts.link||e.parts.image,r=o.getParent(),s=a.createElement("span");s.addClass("cke_image_resizer_wrapper"),s.append(o),s.append(i),e.element.append(s,!0),r.is("span")&&r.remove()}i.on("mousedown",function(o){function r(e,t,n){var i=CKEDITOR.document,o=[];if(a.equals(i)||o.push(i.on(e,t)),o.push(a.on(e,t)),n)for(e=o.length;e--;)n.push(o.pop())}function s(){u=T+v*p,d=Math.round(u/C)}function l(){d=y-m,u=Math.round(d*C)}var c,u,d,h,p,m,f,g=e.parts.image,v="right"==e.data.align?-1:1,E=o.data.$.screenX,b=o.data.$.screenY,T=g.$.clientWidth,y=g.$.clientHeight,C=T/y,k=[],R="cke_image_s"+(~v?"e":"w");t.fire("saveSnapshot"),r("mousemove",function(e){c=e.data.$,p=c.screenX-E,m=b-c.screenY,f=Math.abs(p/m),1==v?0>=p?0>=m?s():f>=C?s():l():0>=m?f>=C?l():s():l():0>=p?0>=m?f>=C?l():s():l():0>=m?s():f>=C?s():l(),15<=u&&15<=d?(g.setAttributes({width:u,height:d}),h=!0):h=!1},k),r("mouseup",function(){for(var a;a=k.pop();)a.removeListener();n.removeClass(R),i.removeClass("cke_image_resizing"),h&&(e.setData({width:u,height:d}),t.fire("saveSnapshot")),h=!1},k),n.addClass(R),i.addClass("cke_image_resizing")}),e.on("data",function(){i["right"==e.data.align?"addClass":"removeClass"]("cke_image_resizer_left")})}function r(e){var t,n=[];return function(a){var i=e.getCommand("justify"+a);i&&(n.push(function(){i.refresh(e,e.elementPath())}),a in{right:1,left:1,center:1}&&i.on("exec",function(t){var i=l(e);if(i){for(i.setData("align",a),i=n.length;i--;)n[i]();t.cancel()}}),i.on("refresh",function(n){var i=l(e),o={right:1,left:1,center:1};i&&(void 0===t&&(t=e.filter.checkFeature(e.widgets.registered.image.features.align)),t?this.setState(i.data.align==a?CKEDITOR.TRISTATE_ON:a in o?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED):this.setState(CKEDITOR.TRISTATE_DISABLED),n.cancel())}))}}function s(e){e.plugins.link&&(CKEDITOR.on("dialogDefinition",function(t){if(t=t.data,"link"==t.name){t=t.definition;var n=t.onShow,a=t.onOk;t.onShow=function(){var t=l(e);t&&(t.inline?!t.wrapper.getAscendant("a"):1)?this.setupContent(t.data.link||{}):n.apply(this,arguments)},t.onOk=function(){var t=l(e);if(t&&(t.inline?!t.wrapper.getAscendant("a"):1)){var n={};this.commitContent(n),t.setData("link",n)}else a.apply(this,arguments)}}}),e.getCommand("unlink").on("exec",function(t){var n=l(e);n&&n.parts.link&&(n.setData("link",null),this.refresh(e,e.elementPath()),t.cancel())}),e.getCommand("unlink").on("refresh",function(t){var n=l(e);n&&(this.setState(n.data.link||n.wrapper.getAscendant("a")?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED),t.cancel())}))}function l(e){return(e=e.widgets.focused)&&"image"==e.name?e:null}function c(e){var t=e.config.image2_alignClasses;return e={div:{match:a(e)},p:{match:a(e)},img:{attributes:"!src,alt,width,height"},figure:{classes:"!"+e.config.image2_captionedClass},figcaption:!0},t?(e.div.classes=t[1],e.p.classes=e.div.classes,e.img.classes=t[0]+","+t[2],e.figure.classes+=","+e.img.classes):(e.div.styles="text-align",e.p.styles="text-align",e.img.styles="float",e.figure.styles="float,display"),e}function u(e){return e=e.config.image2_alignClasses,{dimension:{requiredContent:"img[width,height]"},align:{requiredContent:"img"+(e?"("+e[0]+")":"{float}")},caption:{requiredContent:"figcaption"}}}function d(e){return e.data.hasCaption?e.element:e.parts.image}var h=new CKEDITOR.template('<figure class="{captionedClass}"><img alt="" src="" /><figcaption>{captionPlaceholder}</figcaption></figure>'),p={left:0,center:1,right:2},m=/^\s*(\d+\%)\s*$/i;CKEDITOR.plugins.add("image2",{lang:"en",requires:"widget,dialog",icons:"image",hidpi:!0,onLoad:function(){CKEDITOR.addCss(".cke_image_nocaption{line-height:0}.cke_editable.cke_image_sw, .cke_editable.cke_image_sw *{cursor:sw-resize !important}.cke_editable.cke_image_se, .cke_editable.cke_image_se *{cursor:se-resize !important}.cke_image_resizer{display:none;position:absolute;width:10px;height:10px;bottom:-5px;right:-5px;background:#000;outline:1px solid #fff;line-height:0;cursor:se-resize;}.cke_image_resizer_wrapper{position:relative;display:inline-block;line-height:0;}.cke_image_resizer.cke_image_resizer_left{right:auto;left:-5px;cursor:sw-resize;}.cke_widget_wrapper:hover .cke_image_resizer,.cke_image_resizer.cke_image_resizing{display:block}.cke_widget_wrapper>a{display:inline-block}")},init:function(t){var n=t.config,a=t.lang.image2,i=e(t);n.filebrowserImage2BrowseUrl=n.filebrowserImageBrowseUrl,n.filebrowserImage2UploadUrl=n.filebrowserImageUploadUrl,i.pathName=a.pathName,i.editables.caption.pathName=a.pathNameCaption,t.widgets.add("image",i),t.ui.addButton&&t.ui.addButton("Image",{label:t.lang.common.image,command:"image",toolbar:"insert,10"}),t.contextMenu&&(t.addMenuGroup("image",10),t.addMenuItem("image",{label:a.menu,command:"image",group:"image"})),CKEDITOR.dialog.add("image2",this.path+"dialogs/image2.js")},afterInit:function(e){var t,n={left:1,right:1,center:1,block:1},a=r(e);for(t in n)a(t);s(e)}}),CKEDITOR.plugins.image2={stateShifter:function(e){function t(e,t){var o={};return i?o.attributes={"class":i[1]}:o.styles={"text-align":"center"},o=a.createElement(e.activeEnterMode==CKEDITOR.ENTER_P?"p":"div",o),n(o,t),t.move(o),o}function n(t,n){if(n.getParent()){var a=e.createRange();a.moveToPosition(n,CKEDITOR.POSITION_BEFORE_START),n.remove(),r.insertElementIntoRange(t,a)}else t.replace(n)}var a=e.document,i=e.config.image2_alignClasses,o=e.config.image2_captionedClass,r=e.editable(),s=["hasCaption","align","link"],l={align:function(n,a,o){var r=n.element;n.changed.align?n.newData.hasCaption||("center"==o&&(n.deflate(),n.element=t(e,r)),n.changed.hasCaption||"center"!=a||"center"==o||(n.deflate(),a=r.findOne("a,img"),a.replace(r),n.element=a)):"center"==o&&n.changed.hasCaption&&!n.newData.hasCaption&&(n.deflate(),n.element=t(e,r)),!i&&r.is("figure")&&("center"==o?r.setStyle("display","inline-block"):r.removeStyle("display"))},hasCaption:function(t,i,r){t.changed.hasCaption&&(i=t.element.is({img:1,a:1})?t.element:t.element.findOne("a,img"),t.deflate(),r?(r=CKEDITOR.dom.element.createFromHtml(h.output({captionedClass:o,captionPlaceholder:e.lang.image2.captionPlaceholder}),a),n(r,t.element),i.replace(r.findOne("img")),t.element=r):(i.replace(t.element),t.element=i))},link:function(t,n,i){if(t.changed.link){var o,r=t.element.is("img")?t.element:t.element.findOne("img"),s=t.element.is("a")?t.element:t.element.findOne("a"),l=t.element.is("a")&&!i||t.element.is("img")&&i;l&&t.deflate(),i?(n||(o=a.createElement("a",{attributes:{href:t.newData.link.url}}),o.replace(r),r.move(o)),i=CKEDITOR.plugins.image2.getLinkAttributesGetter()(e,i),CKEDITOR.tools.isEmpty(i.set)||(o||s).setAttributes(i.set),i.removed.length&&(o||s).removeAttributes(i.removed)):(i=s.findOne("img"),i.replace(s),o=i),l&&(t.element=o)}}};return function(e){var t,n;for(e.changed={},n=0;n<s.length;n++)t=s[n],e.changed[t]=!!e.oldData&&e.oldData[t]!==e.newData[t];for(n=0;n<s.length;n++)t=s[n],l[t](e,e.oldData?e.oldData[t]:null,e.newData[t]);e.inflate()}},checkHasNaturalRatio:function(e){var t=e.$;return e=this.getNatural(e),Math.round(t.clientWidth/e.width*e.height)==t.clientHeight||Math.round(t.clientHeight/e.height*e.width)==t.clientWidth},getNatural:function(e){if(e.$.naturalWidth)e={width:e.$.naturalWidth,height:e.$.naturalHeight};else{var t=new Image;t.src=e.getAttribute("src"),e={width:t.width,height:t.height}}return e},getLinkAttributesGetter:function(){return CKEDITOR.plugins.link.getLinkAttributes},getLinkAttributesParser:function(){return CKEDITOR.plugins.link.parseLinkAttributes}}}(),CKEDITOR.config.image2_captionedClass="image";