CKEDITOR.dialog.add("image2",function(e){function t(){var e=this.getValue().match(k);return(e=!(!e||0===parseInt(e[1],10)))||alert(O["invalid"+CKEDITOR.tools.capitalize(this.id)]),e}function n(){function e(e,a){n.push(t.once(e,function(e){for(var t;t=n.pop();)t.removeListener();a(e)}))}var t=s.createElement("img"),n=[];return function(n,a,i){e("load",function(){var e=x(t);a.call(i,t,e.width,e.height)}),e("error",function(){a(null)}),e("abort",function(){a(null)}),t.setAttribute("src",(A.baseHref||"")+n+"?"+Math.random().toString(16).substring(2))}}function a(){var t=this.getValue();r(!1),t!==l.data.src?(u(t,function(t,n,a){return r(!0),t?(T.setValue(!1===e.config.image2_prefillDimensions?0:n),y.setValue(!1===e.config.image2_prefillDimensions?0:a),p=n,m=a,void o(S.checkHasNaturalRatio(t))):o(!1)}),f=!0):f?(r(!0),T.setValue(d),y.setValue(h),f=!1):r(!0)}function i(){if(g){var e=this.getValue();if(e&&(e.match(k)||o(!1),"0"!==e)){var t="width"==this.id,n=d||p,a=h||m,e=t?Math.round(e/n*a):Math.round(e/a*n);isNaN(e)||(t?y:T).setValue(e)}}}function o(e){if(E){if("boolean"==typeof e){if(v)return;g=e}else e=T.getValue(),v=!0,(g=!g)&&e&&(e*=h/d,isNaN(e)||y.setValue(Math.round(e)));E[g?"removeClass":"addClass"]("cke_btn_unlocked"),E.setAttribute("aria-checked",g),CKEDITOR.env.hc&&E.getChild(0).setHtml(g?CKEDITOR.env.ie?"\u25a0":"\u25a3":CKEDITOR.env.ie?"\u25a1":"\u25a2")}}function r(e){e=e?"enable":"disable",T[e](),y[e]()}var s,l,c,u,d,h,p,m,f,g,v,E,b,T,y,C,k=/(^\s*(\d+)(px)?\s*$)|^$/i,R=CKEDITOR.tools.getNextId(),I=CKEDITOR.tools.getNextId(),D=e.lang.image2,O=e.lang.common,w=new CKEDITOR.template('<div><a href="javascript:void(0)" tabindex="-1" title="'+D.lockRatio+'" class="cke_btn_locked" id="{lockButtonId}" role="checkbox"><span class="cke_icon"></span><span class="cke_label">'+D.lockRatio+'</span></a><a href="javascript:void(0)" tabindex="-1" title="'+D.resetSize+'" class="cke_btn_reset" id="{resetButtonId}" role="button"><span class="cke_label">'+D.resetSize+"</span></a></div>").output({lockButtonId:R,resetButtonId:I}),S=CKEDITOR.plugins.image2,A=e.config,_=e.widgets.registered.image.features,x=S.getNatural,N=!(!A.filebrowserImageBrowseUrl&&!A.filebrowserBrowseUrl),K=[{id:"src",type:"text",label:O.url,onKeyup:a,onChange:a,setup:function(e){this.setValue(e.data.src)},commit:function(e){e.setData("src",this.getValue())},validate:CKEDITOR.dialog.validate.notEmpty(D.urlMissing)}];return N&&K.push({type:"button",id:"browse",style:"display:inline-block;margin-top:14px;",align:"center",label:e.lang.common.browseServer,hidden:!0,filebrowser:"info:src"}),{title:D.title,minWidth:250,minHeight:100,onLoad:function(){s=this._.element.getDocument(),u=n()},onShow:function(){l=this.widget,c=l.parts.image,f=v=g=!1,C=x(c),p=d=C.width,m=h=C.height},contents:[{id:"info",label:D.infoTab,elements:[{type:"vbox",padding:0,children:[{type:"hbox",widths:["100%"],children:K}]},{id:"alt",type:"text",label:D.alt,setup:function(e){this.setValue(e.data.alt)},commit:function(e){e.setData("alt",this.getValue())}},{type:"hbox",widths:["25%","25%","50%"],requiredContent:_.dimension.requiredContent,children:[{type:"text",width:"45px",id:"width",label:O.width,validate:t,onKeyUp:i,onLoad:function(){T=this},setup:function(e){this.setValue(e.data.width)},commit:function(e){e.setData("width",this.getValue())}},{type:"text",id:"height",width:"45px",label:O.height,validate:t,onKeyUp:i,onLoad:function(){y=this},setup:function(e){this.setValue(e.data.height)},commit:function(e){e.setData("height",this.getValue())}},{id:"lock",type:"html",style:"margin-top:18px;width:40px;height:20px;",onLoad:function(){function e(e){e.on("mouseover",function(){this.addClass("cke_btn_over")},e),e.on("mouseout",function(){this.removeClass("cke_btn_over")},e)}var t=this.getDialog();E=s.getById(R),b=s.getById(I),E&&(t.addFocusable(E,4+N),E.on("click",function(e){o(),e.data&&e.data.preventDefault()},this.getDialog()),e(E)),b&&(t.addFocusable(b,5+N),b.on("click",function(e){f?(T.setValue(p),y.setValue(m)):(T.setValue(d),y.setValue(h)),e.data&&e.data.preventDefault()},this),e(b))},setup:function(e){o(e.data.lock)},commit:function(e){e.setData("lock",g)},html:w}]},{type:"hbox",id:"alignment",requiredContent:_.align.requiredContent,children:[{id:"align",type:"radio",items:[[O.alignNone,"none"],[O.alignLeft,"left"],[O.alignCenter,"center"],[O.alignRight,"right"]],label:O.align,setup:function(e){this.setValue(e.data.align)},commit:function(e){e.setData("align",this.getValue())}}]},{id:"hasCaption",type:"checkbox",label:D.captioned,requiredContent:_.caption.requiredContent,setup:function(e){this.setValue(e.data.hasCaption)},commit:function(e){e.setData("hasCaption",this.getValue())}}]},{id:"Upload",hidden:!0,filebrowser:"uploadButton",label:D.uploadTab,elements:[{type:"file",id:"upload",label:D.btnUpload,style:"height:40px"},{type:"fileButton",id:"uploadButton",filebrowser:"info:src",label:D.btnUpload,"for":["Upload","upload"]}]}]}});