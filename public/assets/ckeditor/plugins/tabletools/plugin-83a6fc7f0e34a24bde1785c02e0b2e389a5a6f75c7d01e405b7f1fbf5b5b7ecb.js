!function(){function e(e){function t(e){0<n.length||e.type!=CKEDITOR.NODE_ELEMENT||!h.test(e.getName())||e.getCustomData("selected_cell")||(CKEDITOR.dom.element.setMarker(a,e,"selected_cell",!0),n.push(e))}e=e.getRanges();for(var n=[],a={},i=0;i<e.length;i++){var r=e[i];if(r.collapsed)r=r.getCommonAncestor(),(r=r.getAscendant("td",!0)||r.getAscendant("th",!0))&&n.push(r);else{var o,r=new CKEDITOR.dom.walker(r);for(r.guard=t;o=r.next();)o.type==CKEDITOR.NODE_ELEMENT&&o.is(CKEDITOR.dtd.table)||(o=o.getAscendant("td",!0)||o.getAscendant("th",!0))&&!o.getCustomData("selected_cell")&&(CKEDITOR.dom.element.setMarker(a,o,"selected_cell",!0),n.push(o))}}return CKEDITOR.dom.element.clearAllMarkers(a),n}function t(t,n){for(var a=e(t),i=a[0],r=i.getAscendant("table"),i=i.getDocument(),o=a[0].getParent(),s=o.$.rowIndex,a=a[a.length-1],l=a.getParent().$.rowIndex+a.$.rowSpan-1,a=new CKEDITOR.dom.element(r.$.rows[l]),s=n?s:l,o=n?o:a,a=CKEDITOR.tools.buildTableMap(r),r=a[s],s=n?a[s-1]:a[s+1],a=a[0].length,i=i.createElement("tr"),l=0;r[l]&&l<a;l++){var c;1<r[l].rowSpan&&s&&r[l]==s[l]?(c=r[l],c.rowSpan+=1):(c=new CKEDITOR.dom.element(r[l]).clone(),c.removeAttribute("rowSpan"),c.appendBogus(),i.append(c),c=c.$),l+=c.colSpan-1}n?i.insertBefore(o):i.insertAfter(o)}function n(t){if(t instanceof CKEDITOR.dom.selection){var a=e(t),i=a[0].getAscendant("table"),r=CKEDITOR.tools.buildTableMap(i);t=a[0].getParent().$.rowIndex;for(var a=a[a.length-1],o=a.getParent().$.rowIndex+a.$.rowSpan-1,a=[],s=t;s<=o;s++){for(var l=r[s],c=new CKEDITOR.dom.element(i.$.rows[s]),u=0;u<l.length;u++){var d=new CKEDITOR.dom.element(l[u]),h=d.getParent().$.rowIndex;1==d.$.rowSpan?d.remove():(--d.$.rowSpan,h==s&&(h=r[s+1],h[u-1]?d.insertAfter(new CKEDITOR.dom.element(h[u-1])):new CKEDITOR.dom.element(i.$.rows[s+1]).append(d,1))),u+=d.$.colSpan-1}a.push(c)}for(r=i.$.rows,i=new CKEDITOR.dom.element(r[o+1]||(0<t?r[t-1]:null)||i.$.parentNode),s=a.length;0<=s;s--)n(a[s]);return i}return t instanceof CKEDITOR.dom.element&&(i=t.getAscendant("table"),1==i.$.rows.length?i.remove():t.remove()),null}function a(e,t){for(var n=t?1/0:0,a=0;a<e.length;a++){var i;i=e[a];for(var r=t,o=i.getParent().$.cells,s=0,l=0;l<o.length;l++){var c=o[l],s=s+(r?1:c.colSpan);if(c==i.$)break}i=s-1,(t?i<n:i>n)&&(n=i)}return n}function i(t,n){for(var i=e(t),r=i[0].getAscendant("table"),o=a(i,1),i=a(i),o=n?o:i,s=CKEDITOR.tools.buildTableMap(r),r=[],i=[],l=s.length,c=0;c<l;c++)r.push(s[c][o]),i.push(n?s[c][o-1]:s[c][o+1]);for(c=0;c<l;c++)r[c]&&(1<r[c].colSpan&&i[c]==r[c]?(o=r[c],o.colSpan+=1):(o=new CKEDITOR.dom.element(r[c]).clone(),o.removeAttribute("colSpan"),o.appendBogus(),o[n?"insertBefore":"insertAfter"].call(o,new CKEDITOR.dom.element(r[c])),o=o.$),c+=o.rowSpan-1)}function r(e,t){var n=e.getStartElement();if(n=n.getAscendant("td",1)||n.getAscendant("th",1)){var a=n.clone();a.appendBogus(),t?a.insertBefore(n):a.insertAfter(n)}}function o(t){if(t instanceof CKEDITOR.dom.selection){t=e(t);var n,a=t[0]&&t[0].getAscendant("table");e:{var i=0;n=t.length-1;for(var r,l,c={};r=t[i++];)CKEDITOR.dom.element.setMarker(c,r,"delete_cell",!0);for(i=0;r=t[i++];)if((l=r.getPrevious())&&!l.getCustomData("delete_cell")||(l=r.getNext())&&!l.getCustomData("delete_cell")){CKEDITOR.dom.element.clearAllMarkers(c),n=l;break e}CKEDITOR.dom.element.clearAllMarkers(c),l=t[0].getParent(),(l=l.getPrevious())?n=l.getLast():(l=t[n].getParent(),n=(l=l.getNext())?l.getChild(0):null)}for(l=t.length-1;0<=l;l--)o(t[l]);n?s(n,!0):a&&a.remove()}else t instanceof CKEDITOR.dom.element&&(a=t.getParent(),1==a.getChildCount()?a.remove():t.remove())}function s(e,t){var n=e.getDocument(),a=CKEDITOR.document;CKEDITOR.env.ie&&10==CKEDITOR.env.version&&(a.focus(),n.focus()),n=new CKEDITOR.dom.range(n),n["moveToElementEdit"+(t?"End":"Start")](e)||(n.selectNodeContents(e),n.collapse(!t)),n.select(!0)}function l(e,t,n){if(e=e[t],"undefined"==typeof n)return e;for(t=0;e&&t<e.length;t++){if(n.is&&e[t]==n.$)return t;if(t==n)return new CKEDITOR.dom.element(e[t])}return n.is?-1:null}function c(t,n,a){var i,r=e(t);if((n?1!=r.length:2>r.length)||(i=t.getCommonAncestor())&&i.type==CKEDITOR.NODE_ELEMENT&&i.is("table"))return!1;var o;t=r[0],i=t.getAscendant("table");var s=CKEDITOR.tools.buildTableMap(i),c=s.length,u=s[0].length,d=t.getParent().$.rowIndex,h=l(s,d,t);if(n){var m;try{var p=parseInt(t.getAttribute("rowspan"),10)||1;o=parseInt(t.getAttribute("colspan"),10)||1,m=s["up"==n?d-p:"down"==n?d+p:d]["left"==n?h-o:"right"==n?h+o:h]}catch(e){return!1}if(!m||t.$==m)return!1;r["up"==n||"left"==n?"unshift":"push"](new CKEDITOR.dom.element(m))}n=t.getDocument();var f=d,p=m=0,g=!a&&new CKEDITOR.dom.documentFragment(n),v=0;for(n=0;n<r.length;n++){o=r[n];var E=o.getParent(),b=o.getFirst(),y=o.$.colSpan,T=o.$.rowSpan,E=E.$.rowIndex,k=l(s,E,o),v=v+y*T,p=Math.max(p,k-h+y);m=Math.max(m,E-d+T),a||(y=o,(T=y.getBogus())&&T.remove(),y.trim(),o.getChildren().count()&&(E==f||!b||b.isBlockBoundary&&b.isBlockBoundary({br:1})||(f=g.getLast(CKEDITOR.dom.walker.whitespaces(!0)),!f||f.is&&f.is("br")||g.append("br")),o.moveChildren(g)),n?o.remove():o.setHtml("")),f=E}if(a)return m*p==v;for(g.moveChildren(t),t.appendBogus(),p>=u?t.removeAttribute("rowSpan"):t.$.rowSpan=m,m>=c?t.removeAttribute("colSpan"):t.$.colSpan=p,a=new CKEDITOR.dom.nodeList(i.$.rows),r=a.count(),n=r-1;0<=n;n--)i=a.getItem(n),i.$.cells.length||(i.remove(),r++);return t}function u(t,n){var a=e(t);if(1<a.length)return!1;if(n)return!0;var i,a=a[0],r=a.getParent(),o=r.getAscendant("table"),s=CKEDITOR.tools.buildTableMap(o),c=r.$.rowIndex,u=l(s,c,a),d=a.$.rowSpan;if(1<d){i=Math.ceil(d/2);for(var h,d=Math.floor(d/2),r=c+i,o=new CKEDITOR.dom.element(o.$.rows[r]),s=l(s,r),r=a.clone(),c=0;c<s.length;c++){if(h=s[c],h.parentNode==o.$&&c>u){r.insertBefore(new CKEDITOR.dom.element(h));break}h=null}h||o.append(r)}else for(d=i=1,o=r.clone(),o.insertAfter(r),o.append(r=a.clone()),h=l(s,c),u=0;u<h.length;u++)h[u].rowSpan++;return r.appendBogus(),a.$.rowSpan=i,r.$.rowSpan=d,1==i&&a.removeAttribute("rowSpan"),1==d&&r.removeAttribute("rowSpan"),r}function d(t,n){var a=e(t);if(1<a.length)return!1;if(n)return!0;var a=a[0],i=a.getParent(),r=i.getAscendant("table"),r=CKEDITOR.tools.buildTableMap(r),o=l(r,i.$.rowIndex,a),s=a.$.colSpan;if(1<s)i=Math.ceil(s/2),s=Math.floor(s/2);else{for(var s=i=1,c=[],u=0;u<r.length;u++){var d=r[u];c.push(d[o]),1<d[o].rowSpan&&(u+=d[o].rowSpan-1)}for(r=0;r<c.length;r++)c[r].colSpan++}return r=a.clone(),r.insertAfter(a),r.appendBogus(),a.$.colSpan=i,r.$.colSpan=s,1==i&&a.removeAttribute("colSpan"),1==s&&r.removeAttribute("colSpan"),r}var h=/^(?:td|th)$/;CKEDITOR.plugins.tabletools={requires:"table,dialog,contextmenu",init:function(a){function l(e){return CKEDITOR.tools.extend(e||{},{contextSensitive:1,refresh:function(e,t){this.setState(t.contains({td:1,th:1},1)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED)}})}function h(e,t){var n=a.addCommand(e,t);a.addFeature(n)}var m=a.lang.table;h("cellProperties",new CKEDITOR.dialogCommand("cellProperties",l({allowedContent:"td th{width,height,border-color,background-color,white-space,vertical-align,text-align}[colspan,rowspan]",requiredContent:"table"}))),CKEDITOR.dialog.add("cellProperties",this.path+"dialogs/tableCell.js"),h("rowDelete",l({requiredContent:"table",exec:function(e){e=e.getSelection(),s(n(e))}})),h("rowInsertBefore",l({requiredContent:"table",exec:function(e){e=e.getSelection(),t(e,!0)}})),h("rowInsertAfter",l({requiredContent:"table",exec:function(e){e=e.getSelection(),t(e)}})),h("columnDelete",l({requiredContent:"table",exec:function(t){t=t.getSelection(),t=e(t);var n=t[0],a=t[t.length-1];t=n.getAscendant("table");for(var i,r,o=CKEDITOR.tools.buildTableMap(t),l=[],c=0,u=o.length;c<u;c++)for(var d=0,h=o[c].length;d<h;d++)o[c][d]==n.$&&(i=d),o[c][d]==a.$&&(r=d);for(c=i;c<=r;c++)for(d=0;d<o.length;d++)a=o[d],n=new CKEDITOR.dom.element(t.$.rows[d]),a=new CKEDITOR.dom.element(a[c]),a.$&&(1==a.$.colSpan?a.remove():--a.$.colSpan,d+=a.$.rowSpan-1,n.$.cells.length||l.push(n));r=t.$.rows[0]&&t.$.rows[0].cells,i=new CKEDITOR.dom.element(r[i]||(i?r[i-1]:t.$.parentNode)),l.length==u&&t.remove(),i&&s(i,!0)}})),h("columnInsertBefore",l({requiredContent:"table",exec:function(e){e=e.getSelection(),i(e,!0)}})),h("columnInsertAfter",l({requiredContent:"table",exec:function(e){e=e.getSelection(),i(e)}})),h("cellDelete",l({requiredContent:"table",exec:function(e){e=e.getSelection(),o(e)}})),h("cellMerge",l({allowedContent:"td[colspan,rowspan]",requiredContent:"td[colspan,rowspan]",exec:function(e){s(c(e.getSelection()),!0)}})),h("cellMergeRight",l({allowedContent:"td[colspan]",requiredContent:"td[colspan]",exec:function(e){s(c(e.getSelection(),"right"),!0)}})),h("cellMergeDown",l({allowedContent:"td[rowspan]",requiredContent:"td[rowspan]",exec:function(e){s(c(e.getSelection(),"down"),!0)}})),h("cellVerticalSplit",l({allowedContent:"td[rowspan]",requiredContent:"td[rowspan]",exec:function(e){s(d(e.getSelection()))}})),h("cellHorizontalSplit",l({allowedContent:"td[colspan]",requiredContent:"td[colspan]",exec:function(e){s(u(e.getSelection()))}})),h("cellInsertBefore",l({requiredContent:"table",exec:function(e){e=e.getSelection(),r(e,!0)}})),h("cellInsertAfter",l({requiredContent:"table",exec:function(e){e=e.getSelection(),r(e)}})),a.addMenuItems&&a.addMenuItems({tablecell:{label:m.cell.menu,group:"tablecell",order:1,getItems:function(){var t=a.getSelection(),n=e(t);return{tablecell_insertBefore:CKEDITOR.TRISTATE_OFF,tablecell_insertAfter:CKEDITOR.TRISTATE_OFF,tablecell_delete:CKEDITOR.TRISTATE_OFF,tablecell_merge:c(t,null,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_merge_right:c(t,"right",!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_merge_down:c(t,"down",!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_split_vertical:d(t,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_split_horizontal:u(t,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_properties:0<n.length?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED}}},tablecell_insertBefore:{label:m.cell.insertBefore,group:"tablecell",command:"cellInsertBefore",order:5},tablecell_insertAfter:{label:m.cell.insertAfter,group:"tablecell",command:"cellInsertAfter",order:10},tablecell_delete:{label:m.cell.deleteCell,group:"tablecell",command:"cellDelete",order:15},tablecell_merge:{label:m.cell.merge,group:"tablecell",command:"cellMerge",order:16},tablecell_merge_right:{label:m.cell.mergeRight,group:"tablecell",command:"cellMergeRight",order:17},tablecell_merge_down:{label:m.cell.mergeDown,group:"tablecell",command:"cellMergeDown",order:18},tablecell_split_horizontal:{label:m.cell.splitHorizontal,group:"tablecell",command:"cellHorizontalSplit",order:19},tablecell_split_vertical:{label:m.cell.splitVertical,group:"tablecell",command:"cellVerticalSplit",order:20},tablecell_properties:{label:m.cell.title,group:"tablecellproperties",command:"cellProperties",order:21},tablerow:{label:m.row.menu,group:"tablerow",order:1,getItems:function(){return{tablerow_insertBefore:CKEDITOR.TRISTATE_OFF,tablerow_insertAfter:CKEDITOR.TRISTATE_OFF,tablerow_delete:CKEDITOR.TRISTATE_OFF}}},tablerow_insertBefore:{label:m.row.insertBefore,group:"tablerow",command:"rowInsertBefore",order:5},tablerow_insertAfter:{label:m.row.insertAfter,group:"tablerow",command:"rowInsertAfter",order:10},tablerow_delete:{label:m.row.deleteRow,group:"tablerow",command:"rowDelete",order:15},tablecolumn:{label:m.column.menu,group:"tablecolumn",order:1,getItems:function(){return{tablecolumn_insertBefore:CKEDITOR.TRISTATE_OFF,tablecolumn_insertAfter:CKEDITOR.TRISTATE_OFF,tablecolumn_delete:CKEDITOR.TRISTATE_OFF}}},tablecolumn_insertBefore:{label:m.column.insertBefore,group:"tablecolumn",command:"columnInsertBefore",order:5},tablecolumn_insertAfter:{label:m.column.insertAfter,group:"tablecolumn",command:"columnInsertAfter",order:10},tablecolumn_delete:{label:m.column.deleteColumn,group:"tablecolumn",command:"columnDelete",order:15}}),a.contextMenu&&a.contextMenu.addListener(function(e,t,n){return(e=n.contains({td:1,th:1},1))&&!e.isReadOnly()?{tablecell:CKEDITOR.TRISTATE_OFF,tablerow:CKEDITOR.TRISTATE_OFF,tablecolumn:CKEDITOR.TRISTATE_OFF}:null})},getSelectedCells:e},CKEDITOR.plugins.add("tabletools",CKEDITOR.plugins.tabletools)}(),CKEDITOR.tools.buildTableMap=function(e){e=e.$.rows;for(var t=-1,n=[],a=0;a<e.length;a++){t++,!n[t]&&(n[t]=[]);for(var i=-1,r=0;r<e[a].cells.length;r++){var o=e[a].cells[r];for(i++;n[t][i];)i++;for(var s=isNaN(o.colSpan)?1:o.colSpan,o=isNaN(o.rowSpan)?1:o.rowSpan,l=0;l<o;l++){n[t+l]||(n[t+l]=[]);for(var c=0;c<s;c++)n[t+l][i+c]=e[a].cells[r]}i+=s-1}}return n};