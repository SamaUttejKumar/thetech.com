!function(){CKEDITOR.plugins.add("embedbase",{lang:"en",requires:"widget,notificationaggregator",onLoad:function(){CKEDITOR._.jsonpCallbacks={}},init:function(){CKEDITOR.dialog.add("embedBase",this.path+"dialogs/embedbase.js")}});var e={_attachScript:function(e,t){var n=new CKEDITOR.dom.element("script");return n.setAttribute("src",e),n.on("error",t),CKEDITOR.document.getBody().append(n),n},sendRequest:function(e,t,n,o){function a(){r&&(r.remove(),delete CKEDITOR._.jsonpCallbacks[s],r=null)}var i={};t=t||{};var r,s=CKEDITOR.tools.getNextNumber();return t.callback="CKEDITOR._.jsonpCallbacks["+s+"]",CKEDITOR._.jsonpCallbacks[s]=function(e){setTimeout(function(){a(),n(e)})},r=this._attachScript(e.output(t),function(){a(),o&&o()}),i.cancel=a,i}};CKEDITOR.plugins.embedBase={createWidgetBaseDefinition:function(t){var n,o=t.lang.embedbase;return{mask:!0,template:"<div></div>",pathName:o.pathName,_cache:{},urlRegExp:/^((https?:)?\/\/|www\.)/i,init:function(){this.on("sendRequest",function(e){this._sendRequest(e.data)},this,null,999),this.on("dialog",function(e){e.data.widget=this},this),this.on("handleResponse",function(e){if(!e.data.html){var t=this._responseToHtml(e.data.url,e.data.response);null!==t?e.data.html=t:(e.data.errorMessage="unsupportedUrl",e.cancel())}},this,null,999)},loadContent:function(e,t){function n(n){i.response=n,o.editor.widgets.instances[o.id]?o._handleResponse(i)&&(o._cacheResponse(e,n),t.callback&&t.callback()):(CKEDITOR.warn("embedbase-widget-invalid"),i.task&&i.task.done())}t=t||{};var o=this,a=this._getCachedResponse(e),i={noNotifications:t.noNotifications,url:e,callback:n,errorCallback:function(e){o._handleError(i,e),t.errorCallback&&t.errorCallback(e)}};return a?void setTimeout(function(){n(a)}):(t.noNotifications||(i.task=this._createTask()),this.fire("sendRequest",i),i)},isUrlValid:function(e){return this.urlRegExp.test(e)&&!1!==this.fire("validateUrl",e)},getErrorMessage:function(e,n,o){return(o=t.lang.embedbase[e+(o||"")])||(o=e),new CKEDITOR.template(o).output({url:n||""})},_sendRequest:function(t){var n=this,o=e.sendRequest(this.providerUrl,{url:encodeURIComponent(t.url)},t.callback,function(){t.errorCallback("fetchingFailed")});t.cancel=function(){o.cancel(),n.fire("requestCanceled",t)}},_handleResponse:function(e){var t={url:e.url,html:"",response:e.response};return!1!==this.fire("handleResponse",t)?(e.task&&e.task.done(),this._setContent(e.url,t.html),!0):(e.errorCallback(t.errorMessage),!1)},_handleError:function(e,n){e.task&&(e.task.cancel(),e.noNotifications||t.showNotification(this.getErrorMessage(n,e.url),"warning"))},_responseToHtml:function(e,t){return"photo"==t.type?'<img src="'+CKEDITOR.tools.htmlEncodeAttr(t.url)+'" alt="'+CKEDITOR.tools.htmlEncodeAttr(t.title||"")+'" style="max-width:100%;height:auto" />':"video"==t.type||"rich"==t.type?t.html:null},_setContent:function(e,t){this.setData("url",e),this.element.setHtml(t)},_createTask:function(){return n&&!n.isFinished()||(n=new CKEDITOR.plugins.notificationAggregator(t,o.fetchingMany,o.fetchingOne),n.on("finished",function(){n.notification.hide()})),n.createTask()},_cacheResponse:function(e,t){this._cache[e]=t},_getCachedResponse:function(e){return this._cache[e]}}},_jsonp:e}}();