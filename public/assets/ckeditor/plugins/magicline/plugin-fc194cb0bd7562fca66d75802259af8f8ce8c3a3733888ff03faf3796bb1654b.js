!function(){function e(e,t,n){return d(t)&&d(n)&&n.equals(t.getNext(function(e){return!(G(e)||J(e)||h(e))}))}function t(e){this.upper=e[0],this.lower=e[1],this.set.apply(this,e.slice(2))}function n(e){var t=e.element;if(t&&d(t)&&(t=t.getAscendant(e.triggers,!0))&&e.editable.contains(t)){var n=r(t);if("true"==n.getAttribute("contenteditable"))return t;if(n.is(e.triggers))return n}return null}function i(e,t,n){return T(e,t),T(e,n),e=t.size.bottom,n=n.size.top,e&&n?0|(e+n)/2:e||n}function a(e,t,n){return t=t[n?"getPrevious":"getNext"](function(t){return t&&t.type==CKEDITOR.NODE_TEXT&&!G(t)||d(t)&&!h(t)&&!u(e,t)})}function o(e,t,n){return e>t&&e<n}function r(e,t){if(e.data("cke-editable"))return null;for(t||(e=e.getParent());e&&!e.data("cke-editable");){if(e.hasAttribute("contenteditable"))return e;e=e.getParent()}return null}function s(e){var t=e.doc,n=D('<span contenteditable="false" style="'+z+"position:absolute;border-top:1px dashed "+e.boxColor+'"></span>',t),i=CKEDITOR.getUrl(this.path+"images/"+(O.hidpi?"hidpi/":"")+"icon"+(e.rtl?"-rtl":"")+".png");for(R(n,{attach:function(){return this.wrap.getParent()||this.wrap.appendTo(e.editable,!0),this},lineChildren:[R(D('<span title="'+e.editor.lang.magicline.title+'" contenteditable="false">&#8629;</span>',t),{base:z+"height:17px;width:17px;"+(e.rtl?"left":"right")+":17px;background:url("+i+") center no-repeat "+e.boxColor+";cursor:pointer;"+(O.hc?"font-size: 15px;line-height:14px;border:1px solid #fff;text-align:center;":"")+(O.hidpi?"background-size: 9px 10px;":""),looks:["top:-8px; border-radius: 2px;","top:-17px; border-radius: 2px 2px 0px 0px;","top:-1px; border-radius: 0px 0px 2px 2px;"]}),R(D(q,t),{base:W+"left:0px;border-left-color:"+e.boxColor+";",looks:["border-width:8px 0 8px 8px;top:-8px","border-width:8px 0 0 8px;top:-8px","border-width:0 0 8px 8px;top:0px"]}),R(D(q,t),{base:W+"right:0px;border-right-color:"+e.boxColor+";",looks:["border-width:8px 8px 8px 0;top:-8px","border-width:8px 8px 0 0;top:-8px","border-width:0 8px 8px 0;top:0px"]})],detach:function(){return this.wrap.getParent()&&this.wrap.remove(),this},mouseNear:function(){T(e,this);var t=e.holdDistance,n=this.size;return!!(n&&o(e.mouse.y,n.top-t,n.bottom+t)&&o(e.mouse.x,n.left-t,n.right+t))},place:function(){var t=e.view,n=e.editable,i=e.trigger,a=i.upper,r=i.lower,s=a||r,l=s.getParent(),c={};this.trigger=i,a&&T(e,a,!0),r&&T(e,r,!0),T(e,l,!0),e.inInlineMode&&y(e,!0),l.equals(n)?(c.left=t.scroll.x,c.right=-t.scroll.x,c.width=""):(c.left=s.size.left-s.size.margin.left+t.scroll.x-(e.inInlineMode?t.editable.left+t.editable.border.left:0),c.width=s.size.outerWidth+s.size.margin.left+s.size.margin.right+t.scroll.x,c.right=""),a&&r?c.top=a.size.margin.bottom===r.size.margin.top?0|a.size.bottom+a.size.margin.bottom/2:a.size.margin.bottom<r.size.margin.top?a.size.bottom+a.size.margin.bottom:a.size.bottom+a.size.margin.bottom-r.size.margin.top:a?r||(c.top=a.size.bottom+a.size.margin.bottom):c.top=r.size.top-r.size.margin.top,i.is(P)||o(c.top,t.scroll.y-15,t.scroll.y+5)?(c.top=e.inInlineMode?0:t.scroll.y,this.look(P)):i.is(L)||o(c.top,t.pane.bottom-5,t.pane.bottom+15)?(c.top=e.inInlineMode?t.editable.height+t.editable.padding.top+t.editable.padding.bottom:t.pane.bottom-1,this.look(L)):(e.inInlineMode&&(c.top-=t.editable.top+t.editable.border.top),this.look(F)),e.inInlineMode&&(c.top--,c.top+=t.editable.scroll.top,c.left+=t.editable.scroll.left);for(var u in c)c[u]=CKEDITOR.tools.cssLength(c[u]);this.setStyles(c)},look:function(e){if(this.oldLook!=e){for(var t,n=this.lineChildren.length;n--;)(t=this.lineChildren[n]).setAttribute("style",t.base+t.looks[0|e/2]);this.oldLook=e}},wrap:new I("span",e.doc)}),t=n.lineChildren.length;t--;)n.lineChildren[t].appendTo(n);n.look(F),n.appendTo(n.wrap),n.unselectable(),n.lineChildren[0].on("mouseup",function(t){n.detach(),l(e,function(t){var n=e.line.trigger;t[n.is(_)?"insertBefore":"insertAfter"](n.is(_)?n.lower:n.upper)},!0),e.editor.focus(),O.ie||e.enterMode==CKEDITOR.ENTER_BR||e.hotNode.scrollIntoView(),t.data.preventDefault(!0)}),n.on("mousedown",function(e){e.data.preventDefault(!0)}),e.line=n}function l(e,t,n){var i,a=new CKEDITOR.dom.range(e.doc),o=e.editor;O.ie&&e.enterMode==CKEDITOR.ENTER_BR?i=e.doc.createText(B):(i=(i=r(e.element,!0))&&i.data("cke-enter-mode")||e.enterMode,i=new I(A[i],e.doc),i.is("br")||e.doc.createText(B).appendTo(i)),n&&o.fire("saveSnapshot"),t(i),a.moveToPosition(i,CKEDITOR.POSITION_AFTER_START),o.getSelection().selectRanges([a]),e.hotNode=i,n&&o.fire("saveSnapshot")}function c(e,t){return{canUndo:!0,modes:{wysiwyg:1},exec:function(){function i(n){var i=O.ie&&9>O.version?" ":B,a=e.hotNode&&e.hotNode.getText()==i&&e.element.equals(e.hotNode)&&e.lastCmdDirection===!!t;l(e,function(i){a&&e.hotNode&&e.hotNode.remove(),i[t?"insertAfter":"insertBefore"](n),i.setAttributes({"data-cke-magicline-hot":1,"data-cke-magicline-dir":!!t}),e.lastCmdDirection=!!t}),O.ie||e.enterMode==CKEDITOR.ENTER_BR||e.hotNode.scrollIntoView(),e.line.detach()}return function(o){o=o.getSelection().getStartElement();var s;if(o=o.getAscendant(j,1),!f(e,o)&&o&&!o.equals(e.editable)&&!o.contains(e.editable)){(s=r(o))&&"false"==s.getAttribute("contenteditable")&&(o=s),e.element=o,s=a(e,o,!t);var l;d(s)&&s.is(e.triggers)&&s.is(H)&&(!a(e,s,!t)||(l=a(e,s,!t))&&d(l)&&l.is(e.triggers))?i(s):(l=n(e,o),d(l)&&(a(e,l,!t)?(o=a(e,l,!t))&&d(o)&&o.is(e.triggers)&&i(l):i(l)))}}}()}}function u(e,t){if(!t||t.type!=CKEDITOR.NODE_ELEMENT||!t.$)return!1;var n=e.line;return n.wrap.equals(t)||n.wrap.contains(t)}function d(e){return e&&e.type==CKEDITOR.NODE_ELEMENT&&e.$}function h(e){if(!d(e))return!1;var t;return(t=p(e))||(d(e)?(t={left:1,right:1,center:1},t=!(!t[e.getComputedStyle("float")]&&!t[e.getAttribute("align")])):t=!1),t}function p(e){return!!{absolute:1,fixed:1}[e.getComputedStyle("position")]}function m(e,t){return d(t)?t.is(e.triggers):null}function f(e,t){if(!t)return!1;for(var n=t.getParents(1),i=n.length;i--;)for(var a=e.tabuList.length;a--;)if(n[i].hasAttribute(e.tabuList[a]))return!0;return!1}function g(e,t,n){return!!(t=t[n?"getLast":"getFirst"](function(t){return e.isRelevant(t)&&!t.is($)}))&&(T(e,t),n?t.size.top>e.mouse.y:t.size.bottom<e.mouse.y)}function v(e){var n=e.editable,i=e.mouse,a=e.view,r=e.triggerOffset;y(e);var s=i.y>(e.inInlineMode?a.editable.top+a.editable.height/2:Math.min(a.editable.height,a.pane.height)/2),n=n[s?"getLast":"getFirst"](function(e){return!(G(e)||J(e))});return n?(u(e,n)&&(n=e.line.wrap[s?"getPrevious":"getNext"](function(e){return!(G(e)||J(e))})),d(n)&&!h(n)&&m(e,n)?(T(e,n),!s&&0<=n.size.top&&o(i.y,0,n.size.top+r)?(e=e.inInlineMode||0===a.scroll.y?P:F,new t([null,n,_,K,e])):s&&n.size.bottom<=a.pane.height&&o(i.y,n.size.bottom-r,a.pane.height)?(e=e.inInlineMode||o(n.size.bottom,a.pane.height-r,a.pane.height)?L:F,new t([n,null,x,K,e])):null):null):null}function E(e){var i=e.mouse,r=e.view,s=e.triggerOffset,l=n(e);if(!l)return null;T(e,l);var c,u,s=Math.min(s,0|l.size.outerHeight/2),p=[];if(o(i.y,l.size.top-1,l.size.top+s))u=!1;else{if(!o(i.y,l.size.bottom-s,l.size.bottom+1))return null;u=!0}if(h(l)||g(e,l,u)||l.getParent().is(M))return null;var f=a(e,l,!u);if(f){if(f&&f.type==CKEDITOR.NODE_TEXT)return null;if(d(f)){if(h(f)||!m(e,f)||f.getParent().is(M))return null;p=[f,l][u?"reverse":"concat"]().concat([N,K])}}else l.equals(e.editable[u?"getLast":"getFirst"](e.isRelevant))?(y(e),u&&o(i.y,l.size.bottom-s,r.pane.height)&&o(l.size.bottom,r.pane.height-s,r.pane.height)?c=L:o(i.y,0,l.size.top+s)&&(c=P)):c=F,p=[null,l][u?"reverse":"concat"]().concat([u?x:_,K,c,l.equals(e.editable[u?"getLast":"getFirst"](e.isRelevant))?u?L:P:F]);return 0 in p?new t(p):null}function b(e,t,n,i){for(var a=t.getDocumentPosition(),o={},r={},s={},l={},c=Y.length;c--;)o[Y[c]]=parseInt(t.getComputedStyle.call(t,"border-"+Y[c]+"-width"),10)||0,s[Y[c]]=parseInt(t.getComputedStyle.call(t,"padding-"+Y[c]),10)||0,r[Y[c]]=parseInt(t.getComputedStyle.call(t,"margin-"+Y[c]),10)||0;return n&&!i||C(e,i),l.top=a.y-(n?0:e.view.scroll.y),l.left=a.x-(n?0:e.view.scroll.x),l.outerWidth=t.$.offsetWidth,l.outerHeight=t.$.offsetHeight,l.height=l.outerHeight-(s.top+s.bottom+o.top+o.bottom),l.width=l.outerWidth-(s.left+s.right+o.left+o.right),l.bottom=l.top+l.outerHeight,l.right=l.left+l.outerWidth,e.inInlineMode&&(l.scroll={top:t.$.scrollTop,left:t.$.scrollLeft}),R({border:o,padding:s,margin:r,ignoreScroll:n},l,!0)}function T(e,t,n){if(!d(t))return t.size=null;if(t.size){if(t.size.ignoreScroll==n&&t.size.date>new Date-U)return null}else t.size={};return R(t.size,b(e,t,n),{date:+new Date},!0)}function y(e,t){e.view.editable=b(e,e.editable,t,!0)}function C(e,t){e.view||(e.view={});var n=e.view;if(!(!t&&n&&n.date>new Date-U)){var i=e.win,n=i.getScrollPosition(),i=i.getViewPaneSize();R(e.view,{scroll:{x:n.x,y:n.y,width:e.doc.$.documentElement.scrollWidth-i.width,height:e.doc.$.documentElement.scrollHeight-i.height},pane:{width:i.width,height:i.height,bottom:i.height+n.y},date:+new Date},!0)}}function k(e,n,i,a){for(var o=a,r=a,s=0,l=!1,c=!1,u=e.view.pane.height,d=e.mouse;d.y+s<u&&0<d.y-s&&(l||(l=n(o,a)),c||(c=n(r,a)),!l&&0<d.y-s&&(o=i(e,{x:d.x,y:d.y-s})),!c&&d.y+s<u&&(r=i(e,{x:d.x,y:d.y+s})),!l||!c);)s+=2;return new t([o,r,null,null])}CKEDITOR.plugins.add("magicline",{lang:"en",init:function(e){var i,o,r,m=e.config,g=m.magicline_triggerOffset||30,T={editor:e,enterMode:m.enterMode,triggerOffset:g,holdDistance:0|g*(m.magicline_holdDistance||.5),boxColor:m.magicline_color||"#ff0000",rtl:"rtl"==m.contentsLangDirection,tabuList:["data-cke-hidden-sel"].concat(m.magicline_tabuList||[]),triggers:m.magicline_everywhere?j:{table:1,hr:1,div:1,ul:1,ol:1,dl:1,form:1,blockquote:1}};T.isRelevant=function(e){return d(e)&&!u(T,e)&&!h(e)},e.on("contentDom",function(){var d=e.editable(),h=e.document,g=e.window;R(T,{editable:d,inInlineMode:d.isInline(),doc:h,win:g,hotNode:null},!0),T.boundary=T.inInlineMode?T.editable:T.doc.getDocumentElement(),d.is(S.$inline)||(T.inInlineMode&&!p(d)&&d.setStyles({position:"relative",top:null,left:null}),s.call(this,T),C(T),d.attachListener(e,"beforeUndoImage",function(){T.line.detach()}),d.attachListener(e,"beforeGetData",function(){T.line.wrap.getParent()&&(T.line.detach(),e.once("getData",function(){T.line.attach()},null,null,1e3))},null,null,0),d.attachListener(T.inInlineMode?h:h.getWindow().getFrame(),"mouseout",function(t){if("wysiwyg"==e.mode)if(T.inInlineMode){var n=t.data.$.clientX;t=t.data.$.clientY,C(T),y(T,!0);var i=T.view.editable,a=T.view.scroll;n>i.left-a.x&&n<i.right-a.x&&t>i.top-a.y&&t<i.bottom-a.y||(clearTimeout(r),r=null,T.line.detach())}else clearTimeout(r),r=null,T.line.detach()}),d.attachListener(d,"keyup",function(){T.hiddenMode=0}),d.attachListener(d,"keydown",function(t){if("wysiwyg"==e.mode)switch(t.data.getKeystroke()){case 2228240:case 16:T.hiddenMode=1,T.line.detach()}}),d.attachListener(T.inInlineMode?d:h,"mousemove",function(t){if(o=!0,"wysiwyg"==e.mode&&!e.readOnly&&!r){var n={x:t.data.$.clientX,y:t.data.$.clientY};r=setTimeout(function(){T.mouse=n,r=T.trigger=null,C(T),o&&!T.hiddenMode&&e.focusManager.hasFocus&&!T.line.mouseNear()&&(T.element=V(T,!0))&&((T.trigger=v(T)||E(T)||Q(T))&&!f(T,T.trigger.upper||T.trigger.lower)?T.line.attach().place():(T.trigger=null,T.line.detach()),o=!1)},30)}}),d.attachListener(g,"scroll",function(){"wysiwyg"==e.mode&&(T.line.detach(),O.webkit&&(T.hiddenMode=1,clearTimeout(i),i=setTimeout(function(){T.mouseDown||(T.hiddenMode=0)},50)))}),d.attachListener(w?h:g,"mousedown",function(){"wysiwyg"==e.mode&&(T.line.detach(),T.hiddenMode=1,T.mouseDown=1)}),d.attachListener(w?h:g,"mouseup",function(){T.hiddenMode=0,T.mouseDown=0}),e.addCommand("accessPreviousSpace",c(T)),e.addCommand("accessNextSpace",c(T,!0)),e.setKeystroke([[m.magicline_keystrokePrevious,"accessPreviousSpace"],[m.magicline_keystrokeNext,"accessNextSpace"]]),e.on("loadSnapshot",function(){var t,n,i,a;for(a in{p:1,br:1,div:1})for(t=e.document.getElementsByTag(a),i=t.count();i--;)if((n=t.getItem(i)).data("cke-magicline-hot"))return T.hotNode=n,void(T.lastCmdDirection="true"===n.data("cke-magicline-dir"))}),this.backdoor={accessFocusSpace:l,boxTrigger:t,isLine:u,getAscendantTrigger:n,getNonEmptyNeighbour:a,getSize:b,that:T,triggerEdge:E,triggerEditable:v,triggerExpand:Q})},this)}});var R=CKEDITOR.tools.extend,I=CKEDITOR.dom.element,D=I.createFromHtml,O=CKEDITOR.env,w=CKEDITOR.env.ie&&9>CKEDITOR.env.version,S=CKEDITOR.dtd,A={},_=128,x=64,N=32,K=16,P=4,L=2,F=1,B="\xa0",M=S.$listItem,$=S.$tableContent,H=R({},S.$nonEditable,S.$empty),j=S.$block,U=100,z="width:0px;height:0px;padding:0px;margin:0px;display:block;z-index:9999;color:#fff;position:absolute;font-size: 0px;line-height:0px;",W=z+"border-color:transparent;display:block;border-style:solid;",q="<span>"+B+"</span>";A[CKEDITOR.ENTER_BR]="br",A[CKEDITOR.ENTER_P]="p",A[CKEDITOR.ENTER_DIV]="div",t.prototype={set:function(e,t,n){return this.properties=e+t+(n||F),this},is:function(e){return(this.properties&e)==e}};var V=function(){function e(e,t){var n=e.$.elementFromPoint(t.x,t.y);return n&&n.nodeType?new CKEDITOR.dom.element(n):null}return function(t,n,i){if(!t.mouse)return null;var a=t.doc,o=t.line.wrap;i=i||t.mouse;var r=e(a,i);return n&&u(t,r)&&(o.hide(),r=e(a,i),o.show()),!r||r.type!=CKEDITOR.NODE_ELEMENT||!r.$||O.ie&&9>O.version&&!t.boundary.equals(r)&&!t.boundary.contains(r)?null:r}}(),G=CKEDITOR.dom.walker.whitespaces(),J=CKEDITOR.dom.walker.nodeType(CKEDITOR.NODE_COMMENT),Q=function(){function t(t){var a,r,s,l=t.element;if(!d(l)||l.contains(t.editable)||l.isReadOnly())return null;if(s=k(t,function(e,t){return!t.equals(e)},function(e,t){return V(e,!0,t)},l),a=s.upper,r=s.lower,e(t,a,r))return s.set(N,8);if(a&&l.contains(a))for(;!a.getParent().equals(l);)a=a.getParent();else a=l.getFirst(function(e){return n(t,e)});if(r&&l.contains(r))for(;!r.getParent().equals(l);)r=r.getParent();else r=l.getLast(function(e){return n(t,e)});if(!a||!r)return null;if(T(t,a),T(t,r),!o(t.mouse.y,a.size.top,r.size.bottom))return null;for(var c,u,h,p,l=Number.MAX_VALUE;r&&!r.equals(a)&&(u=a.getNext(t.isRelevant));)c=Math.abs(i(t,a,u)-t.mouse.y),c<l&&(l=c,h=a,p=u),a=u,T(t,a);return h&&p&&o(t.mouse.y,h.size.top,p.size.bottom)?(s.upper=h,s.lower=p,s.set(N,8)):null}function n(e,t){return!(t&&t.type==CKEDITOR.NODE_TEXT||J(t)||h(t)||u(e,t)||t.type==CKEDITOR.NODE_ELEMENT&&t.$&&t.is("br"))}return function(n){var i,a=t(n);if(i=a){i=a.upper;var o=a.lower;i=!(!i||!o||h(o)||h(i)||o.equals(i)||i.equals(o)||o.contains(i)||i.contains(o))&&!!(m(n,i)&&m(n,o)&&e(n,i,o))}return i?a:null}}(),Y=["top","left","right","bottom"]}(),CKEDITOR.config.magicline_keystrokePrevious=CKEDITOR.CTRL+CKEDITOR.SHIFT+51,CKEDITOR.config.magicline_keystrokeNext=CKEDITOR.CTRL+CKEDITOR.SHIFT+52;