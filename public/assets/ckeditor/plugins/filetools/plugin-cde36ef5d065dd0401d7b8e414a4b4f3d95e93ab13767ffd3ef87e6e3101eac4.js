!function(){function e(e){this.editor=e,this.loaders=[]}function t(e,t,o){var a=e.config.fileTools_defaultFileName;this.editor=e,this.lang=e.lang,"string"==typeof t?(this.data=t,this.file=n(this.data),this.loaded=this.total=this.file.size):(this.data=null,this.file=t,this.total=this.file.size,this.loaded=0),o?this.fileName=o:this.file.name?this.fileName=this.file.name:(e=this.file.type.split("/"),a&&(e[0]=a),this.fileName=e.join(".")),this.uploaded=0,this.responseData=this.uploadTotal=null,this.status="created",this.abort=function(){this.changeStatus("abort")}}function n(e){var t=e.match(o)[1];e=e.replace(o,""),e=atob(e);var n,a,i,r,s=[];for(n=0;n<e.length;n+=512){for(a=e.slice(n,n+512),i=Array(a.length),r=0;r<a.length;r++)i[r]=a.charCodeAt(r);a=new Uint8Array(i),s.push(a)}return new Blob(s,{type:t})}CKEDITOR.plugins.add("filetools",{lang:"en",beforeInit:function(t){t.uploadRepository=new e(t),t.on("fileUploadRequest",function(e){var t=e.data.fileLoader;t.xhr.open("POST",t.uploadUrl,!0),e.data.requestData.upload={file:t.file,name:t.fileName}},null,null,5),t.on("fileUploadRequest",function(e){var t=e.data.fileLoader,n=new FormData;e=e.data.requestData;for(var o in e){var a=e[o];"object"==typeof a&&a.file?n.append(o,a.file,a.name):n.append(o,a)}n.append("ckCsrfToken",CKEDITOR.tools.getCsrfToken()),t.xhr.send(n)},null,null,999),t.on("fileUploadResponse",function(e){var t=e.data.fileLoader,n=t.xhr,o=e.data;try{var a=JSON.parse(n.responseText);if(a.error&&a.error.message&&(o.message=a.error.message),a.uploaded)for(var i in a)o[i]=a[i];else e.cancel()}catch(a){o.message=t.lang.filetools.responseError,CKEDITOR.warn("filetools-response-error",{responseText:n.responseText}),e.cancel()}},null,null,999)}}),e.prototype={create:function(e,n){var o=this.loaders.length,a=new t(this.editor,e,n);return a.id=o,this.loaders[o]=a,this.fire("instanceCreated",a),a},isFinished:function(){for(var e=0;e<this.loaders.length;++e)if(!this.loaders[e].isFinished())return!1;return!0}},t.prototype={loadAndUpload:function(e,t){var n=this;this.once("loaded",function(o){o.cancel(),n.once("update",function(e){e.cancel()},null,null,0),n.upload(e,t)},null,null,0),this.load()},load:function(){var e=this,t=this.reader=new FileReader;e.changeStatus("loading"),this.abort=function(){e.reader.abort()},t.onabort=function(){e.changeStatus("abort")},t.onerror=function(){e.message=e.lang.filetools.loadError,e.changeStatus("error")},t.onprogress=function(t){e.loaded=t.loaded,e.update()},t.onload=function(){e.loaded=e.total,e.data=t.result,e.changeStatus("loaded")},t.readAsDataURL(this.file)},upload:function(e,t){var n=t||{};e?(this.uploadUrl=e,this.xhr=new XMLHttpRequest,this.attachRequestListeners(),this.editor.fire("fileUploadRequest",{fileLoader:this,requestData:n})&&this.changeStatus("uploading")):(this.message=this.lang.filetools.noUrlError,this.changeStatus("error"))},attachRequestListeners:function(){function e(){"error"!=n.status&&(n.message=n.lang.filetools.networkError,n.changeStatus("error"))}function t(){"abort"!=n.status&&n.changeStatus("abort")}var n=this,o=this.xhr;n.abort=function(){o.abort()},o.onerror=e,o.onabort=t,o.upload?(o.upload.onprogress=function(e){e.lengthComputable&&(n.uploadTotal||(n.uploadTotal=e.total),n.uploaded=e.loaded,n.update())},o.upload.onerror=e,o.upload.onabort=t):(n.uploadTotal=n.total,n.update()),o.onload=function(){if(n.update(),"abort"!=n.status)if(n.uploaded=n.uploadTotal,200>o.status||299<o.status)n.message=n.lang.filetools["httpError"+o.status],n.message||(n.message=n.lang.filetools.httpError.replace("%1",o.status)),n.changeStatus("error");else{for(var e={fileLoader:n},t=["message","fileName","url"],a=n.editor.fire("fileUploadResponse",e),i=0;i<t.length;i++){var r=t[i];"string"==typeof e[r]&&(n[r]=e[r])}n.responseData=e,delete n.responseData.fileLoader,!1===a?n.changeStatus("error"):n.changeStatus("uploaded")}}},changeStatus:function(e){this.status=e,"error"!=e&&"abort"!=e&&"loaded"!=e&&"uploaded"!=e||(this.abort=function(){}),this.fire(e),this.update()},update:function(){this.fire("update")},isFinished:function(){return!!this.status.match(/^(?:loaded|uploaded|error|abort)$/)}},CKEDITOR.event.implementOn(e.prototype),CKEDITOR.event.implementOn(t.prototype);var o=/^data:(\S*?);base64,/;CKEDITOR.fileTools||(CKEDITOR.fileTools={}),CKEDITOR.tools.extend(CKEDITOR.fileTools,{uploadRepository:e,fileLoader:t,getUploadUrl:function(e,t){var n=CKEDITOR.tools.capitalize;return t&&e[t+"UploadUrl"]?e[t+"UploadUrl"]:e.uploadUrl?e.uploadUrl:t&&e["filebrowser"+n(t,1)+"UploadUrl"]?e["filebrowser"+n(t,1)+"UploadUrl"]+"&responseType=json":e.filebrowserUploadUrl?e.filebrowserUploadUrl+"&responseType=json":null},isTypeSupported:function(e,t){return!!e.type.match(t)}})}();